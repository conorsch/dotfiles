#!/bin/bash
# Pull up recent media uploads, to review recorded clips of recent gaming.
set -euo pipefail

# Will be used for both remote and local mount points.
media_dir="/mnt/Valhalla/Media/incoming/gaming"
# Media server identity on innernet.
media_host="adolin.ruindev.wg"
# How recent the videos must be to be included.
time_range="${1:-1d}"


# permit optional subcommands
subcommand="${1:-}"

if [[ "$subcommand" = "upload" ]] ; then
  # upload mode should only work on windows, where game clips are
  if ! hostnamectl status --json pretty | jq -r .OperatingSystemPrettyName | grep -q WSL ; then
      gum log --level=error "upload mode only supported under WSL"
      exit 1
  fi
  windows_gaming_captures_dir="/mnt/c/Users/${USER:-conor}/Videos/Captures"
  if [[ ! -d "$windows_gaming_captures_dir" ]] ; then
      gum log --level=error "vids dir not found: $windows_gaming_captures_dir"
      exit 2
  fi
  fd . "$windows_gaming_captures_dir" --changed-within 1d -X ruin-give
  exit 0
fi

# Sort videos on remote host. Vids are uploaded and stored in a directory,
# and should be moved (actually, hard-linked) to an "incoming" dir for review.
gum log --level=debug "organizing vids on remote server"
ssh "$media_host" ./check-for-new-gaming-vids.sh

if ! test -d "$media_dir" ; then
  gum log --level=warn "vids dir not mounted, mounting..."
  # Use other dotfiles script to ensure media directory is mounted locally.
  media-mount
fi

# Look 'em up, and play all recent vids for review.
# The `vlc` invocation silences stderr because otherwise the terminal output is garish.
gum log --level=info "copying latest vids locally"
fd -t f -e mp4 . "$media_dir" --changed-within "$time_range" -X rsync -a --info=progress2 {} ~/vids/


gum log --level=info "playing vids"
# Look 'em up, and play all recent vids for review.
# The `vlc` invocation silences stderr because otherwise the terminal output is garish.
fd -t f -e mp4 . ~/vids --changed-within "$time_range" \
    | sort -n | xargs -r -d '\n' vlc 2>/dev/null
