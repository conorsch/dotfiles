#!/usr/bin/python
from BeautifulSoup import BeautifulSoup
import requests
import re
import sys
import os
from textwrap import wrap, fill
from blessings import Terminal


if len(sys.argv) < 2:
    sys.exit("Provide a word to look up.")

query = sys.argv.pop()
assert isinstance(query, str)

r = requests.get("http://www.etymonline.com/index.php?search=" + query)

soup = BeautifulSoup(r.content, convertEntities=BeautifulSoup.HTML_ENTITIES)

try: 
    hit = soup.dt.a.text
except:
    sys.exit("Found no hits for query '%s'." % query)

def beautify(soupBowl):
    # BeautifulSoup strips out whitespace around in-line markup tags, see 
    # http://stackoverflow.com/a/16767636 for explanation of solution used below.
    beautifulText = ' '.join(unicode(i.string) for i in soupBowl)

    # Clean up 
    beautifulText = re.sub('\s{2,}', ' ', beautifulText)
    beautifulText = re.sub('\s+([,)\].;:])', '\g<1>', beautifulText)
    return beautifulText

def getColumnCount():
    rows, columns = os.popen('stty size').read().split()
    return int(columns)

definition = beautify(soup.dd)
t = Terminal()
print t.bold(hit)
print fill(definition, width=getColumnCount())
