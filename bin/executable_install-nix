#!/usr/bin/env bash
# Helper script to install Nix, from the community installer.
# Prefers the single-user method, rather than multi-user.
# Supports Debian, Fedora, and QubesOS VMs.
#
# The script installs nix, but doesn't upgrade it; to upgrade the version
# of nix on a given machine, see docs at:
#
# https://nix.dev/manual/nix/2.25/installation/upgrading
set -euo pipefail


# Install nix: https://nixos.org/download/ ; skip if nix on PATH.
if ! hash nix > /dev/null 2>&1 ; then
  if hash getenforce > /dev/null 2>&1 && [[ "$(getenforce)" != "Disabled" ]] ; then
    >&2 echo "WARNING: SELinux was enforced, disabling it..."
    sleep 2
    sudo setenforce 0
  fi
  >&2 echo "Installing nix..."
  sh <(curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install) --no-daemon
fi

>&2 echo "Setting up default nix profile with custom packages..."
# We must ensure home-manager is gone, otherwise its paths will
# conflict with those created by the profile installation.
if hash home-manager > /dev/null 2>&1 && hash nix > /dev/null 2>&1 ; then
  >&2 echo "Detected home-manager installation, uninstalling..."
  nix run home-manager/release-25.05 -- uninstall
fi

# We must also ensure that any ad-hoc packages that were installed
# are removed, otherwise the flake installation will fail with conflicts.
# This is mostly about legacy cleanup; we should expect at least "nix"
# and "chezmoi" entries. Disabling via comment, but leaving in-place
# for ad-hoc fixes, if some machine has a dirty default nix profile.
# nix profile list --json | jq '.elements| keys | .[]'  -r | grep -v '^nix$' \
#   | xargs -r nix profile remove

# The chezmoi dotfiles repo has a top-level `flake.nix` which tracks packages.
chezmoi_src_dir="${HOME:?}/.local/share/chezmoi"
if [[ ! -d "$chezmoi_src_dir" ]] ; then
  >&2 echo "ERROR: chezmoi dir doesn't exist: $chezmoi_src_dir"
  exit 1
fi

>&2 echo "Installing local nix flake for tooling..."
if nix profile list | grep -q "chezmoi" ; then
  >&2 echo "Flake already installed, upgrading..."
  nix profile upgrade chezmoi
else
  nix profile install "$chezmoi_src_dir"
fi
