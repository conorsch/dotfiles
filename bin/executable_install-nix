#!/usr/bin/env bash
# Helper script to install Nix, from the community installer,
# in daemon mode. Storing as a custom script on PATH to make it
# easy to call from different contexts, e.g. to rerun interactively
# to update.
set -euo pipefail


>&2 echo "Setting up nix..."

# Qubes requires special-casing: disable SELinux, since Nix will error out if it's enabled,
# and then use the single-user installation style.


# Install nix: https://nixos.org/download/ ; skip if nix on PATH.
if ! hash nix > /dev/null 2>&1 ; then
  # Check whether we're running inside Qubes
  if qubesdb-read /qubes-vm-type > /dev/null 2>&1 ; then
    >&2 echo "Detected Qubes environment, disabling SELinux"
    sleep 2
    sudo setenforce 0
  fi
  sh <(curl -L https://nixos.org/nix/install)
fi

>&2 echo "Setting up default nix profile with custom packages..."
# We must ensure home-manager is gone, otherwise its paths will
# conflict with those created by the profile installation.
if hash home-manager > /dev/null 2>&1 && hash nix > /dev/null 2>&1 ; then
  >&2 echo "Detected home-manager installation, uninstalling..."
  nix run home-manager/release-25.05 -- uninstall
fi

# The chezmoi dotfiles repo has a top-level `flake.nix` which tracks packages.
chezmoi_src_dir="${HOME:?}/.local/share/chezmoi"
if [[ ! -d "$chezmoi_src_dir" ]] ; then
  >&2 echo "ERROR: chezmoi dir doesn't exist: $chezmoi_src_dir"
  exit 1
fi

nix profile add "$chezmoi_src_dir"
