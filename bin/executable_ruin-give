#!/usr/bin/env bash
# script to upload files to ephemeral storage via transfer.sh
set -euo pipefail


REMOTE_UPLOAD_BASE_URL="https://ruin.dev/give"
# parse args
num_files="$#"
if [[ "$num_files" -lt 1 ]] ; then
    gum log --time datetime --level error "Usage: $0 <filepath> [filepath...]"
    exit 1
fi

# convert local filepath string to escaped URL, for upload via POST.
url_escape() {
    local filename="$1"
    shift 1
    python3 -c "import urllib.parse; print(urllib.parse.quote('$filename', safe='~@#$&()*!+=:;,.?/'))"
}

# straight from the transfer endpoint html view:
#
#   $ curl --upload-file ./hello.txt https://ruin.dev/give/hello.txt
#   https://ruin.dev/give/bXUTjn2hCY/hello.txt
#
# TODO: better error handling

i=1
for f in "$@" ; do
    gum log --time datetime --level info "Uploading file: ${i}/${num_files} $f"
    upload_filename="$(url_escape "$(basename "$f")")"
    upload_url="${REMOTE_UPLOAD_BASE_URL}/${upload_filename}"
    # gum log --time datetime --level debug "Uploading to URL: $upload_url"
    curl --upload-file "$f" "$upload_url"
    # curl command emits url plaintext response with new trailing newline.
    echo ''
    i="$(( i + 1 ))"
done
gum log --time datetime --level info "Done!"
